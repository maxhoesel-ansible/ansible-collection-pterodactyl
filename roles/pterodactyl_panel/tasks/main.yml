---
# tasks file for pterodactyl_panel
- name: Verify that required parameters are set
  assert:
    that:
      - pterodactyl_panel_app_key is defined
      - pterodactyl_panel_app_key | length > 0
      - pterodactyl_panel_hashids_salt is defined
      - pterodactyl_panel_hashids_salt | length > 0
      - pterodactyl_panel_db_password is defined
      - pterodactyl_panel_db_password | length > 0

- name: Install depndencies
  include_tasks: "deps.yml"
- name: Install Redis
  include_tasks: "redis.yml"

- name: pterodactyl_panel_webroot is present
  file:
    path: "{{ pterodactyl_panel_webroot }}"
    state: directory
    owner: www-data
    group: www-data
    mode: "750"

- name: Detect existing install and check for available upgrade
  include_tasks: detect_install_upgrade.yml

- name: .env file is installed
  template:
    src: env.j2
    dest: "{{ pterodactyl_panel_webroot }}/.env"
    owner: www-data
    group: www-data
    mode: "600"

- name: Install Panel
  include_tasks: "install.yml"
  when: not pterodactyl_panel_envfile.stat.exists

- name: Upgrade Panel version
  include_tasks: upgrade.yml
  when: (pterodactyl_panel_detected_version|default(pterodactyl_panel_version) != pterodactyl_panel_version)

- name: Schedule systemd timer is present
  copy:
    src: pterosched.timer
    dest: /etc/systemd/system/pterosched.timer
    owner: root
    group: root
    mode: "644"
  notify: Restart schedule service

# Schedules used to be run with cron, but we have since switched to systemd timers - make sure the old residue is gone.
- name: Old Schedule cronjob is absent
  cron:
    name: "Pterodactyl Panel - Schedule"
    state: absent
  register: _crontab_removal
  # Our Debian 11 image apparently doesn't ship with crontab, that also means that there can't be a job set up with it.
  # To prevent having to install crontab just to look for a job that can't exist, we overwrite the error condition
  failed_when: _crontab_removal.failed and 'Failed to find required executable' not in _crontab_removal.msg

- name: Schedule systemd service is present
  template:
    src: pterosched.service.j2
    dest: /etc/systemd/system/pterosched.service
    mode: "644"
    owner: root
    group: root
  notify: Restart schedule service
- name: Schedule timer is enabled and running
  systemd:
    daemon_reload: yes
    name: pterosched.timer
    enabled: yes
    state: started

- name: Queue listener service is present
  template:
    src: pteroq.service.j2
    dest: /etc/systemd/system/pteroq.service
    mode: "644"
    owner: root
    group: root
  notify: Restart queue service
- name: Queue listener service is enabled
  systemd:
    daemon_reload: yes
    name: pteroq.service
    enabled: yes

- name: Configure apache2
  include_tasks: "apache2.yml"
